// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/.prisma"
}

datasource db {
  provider = "postgresql"
}

/**
 * Guild - Root entity for all guild-related data
 * Tracks guild membership and member count
 */
model Guild {
  id                        String @id
  name                      String
  approximateMemberCount    Int    @default(0)
  syncedAt                  DateTime @default(now()) @updatedAt
  
  keywordRules              KeywordRule[]
  notificationChannels      NotificationChannel[]
  memberNotifyMessages      MemberNotifyMessage[]
  reactionRoles             ReactionRole[]
  reactionRolePanels        ReactionRolePanel[]

  @@index([id])
}

/**
 * KeywordRule - Auto-response rules for specific patterns
 */
model KeywordRule {
  guildId   String
  pattern   String
  matchType KeywordMatchType
  response  String
  enabled   Boolean  @default(true)
  editorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@id([guildId, pattern])
  @@index([guildId])
}

enum KeywordMatchType {
  EXACT
  CONTAINS
}

/**
 * NotificationChannel - Where to send member join/leave notifications
 */
model NotificationChannel {
  guildId   String
  type      NotificationType
  channelId String
  enabled   Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  guild     Guild            @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@id([guildId, type])
  @@index([guildId])
}

enum NotificationType {
  MEMBER_JOIN
  MEMBER_LEAVE
}

/**
 * MemberNotifyMessage - Message templates for member notifications
 */
model MemberNotifyMessage {
  guildId     String   @id
  joinMessage String   @default("ğŸ“¥ {user} åŠ å…¥äº† {server}ï¼ç›®å‰å…± {memberCount} ä½æˆå“¡")
  leaveMessage String  @default("ğŸ“¤ {username} é›¢é–‹äº† {server}ã€‚ç›®å‰å‰©é¤˜ {memberCount} ä½æˆå“¡")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId])
}

/**
 * ReactionRole - Maps emoji reactions to Discord roles
 */
model ReactionRole {
  guildId     String
  messageId   String
  emoji       String
  roleId      String
  description String?

  guild       Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@id([guildId, messageId, emoji])
  @@index([guildId])
  @@index([messageId])
}

/**
 * ReactionRolePanel - Groups multiple reaction roles into a single message
 */
model ReactionRolePanel {
  guildId     String
  messageId   String
  channelId   String
  title       String   @default("é¸æ“‡ä½ çš„èº«åˆ†çµ„")
  description String?
  mode        ReactionRoleMode @default(NORMAL)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guild       Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@id([guildId, messageId])
  @@index([guildId])
}

enum ReactionRoleMode {
  NORMAL
  UNIQUE
  VERIFY
}
